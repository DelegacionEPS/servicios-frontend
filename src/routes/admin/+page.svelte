<script lang="ts">
    import type { PageData } from "./$types"
    import {
        Tabs,
        TabItem,
        Input,
        Label,
        Button,
        Select,
        Modal,
        Card,
        TableSearch,
        TableHead,
        TableHeadCell,
        TableBody,
        TableBodyRow,
        TableBodyCell,
        Popover,
        Indicator
    } from "flowbite-svelte"
    import { QuestionCircleSolid } from "flowbite-svelte-icons"
    import { enhance } from "$app/forms"
    import { page } from "$app/stores"
    import dayjs from "dayjs"
    import { DateInput } from "date-picker-svelte"
    import { getMonthDays } from "date-picker-svelte/date-utils"
    let date = new Date()

    // Users' rols
    const rols = [
        { value: "escuela", name: "Escuela" },
        { value: "atencion", name: "Atención" },
        { value: "general", name: "General" }
    ]

    const puestos = [
        { value: 1, name: "Puesto 1" },
        { value: 2, name: "Puesto 2" },
        { value: 3, name: "Puesto 3" }
    ]

    const estados = [
        { value: 0, name: "No Disponible" },
        { value: 1, name: "Disponible" }
    ]

    // Días
    const days = [
        { name: "Lunes", value: 1 },
        { name: "Martes", value: 2 },
        { name: "Miércoles", value: 3 },
        { name: "Jueves", value: 4 },
        { name: "Viernes", value: 5 }
    ]

    const franjas = [9, 11, 15, 17]

    // Calendar
    const theme = {
        calendar: {
            width: "38vw",
            shadow: "5px 5px 5px rgba(0, 0, 0, 0.25)",
            colors: {
                background: {
                    hover: "#FF6D2E",
                    highlight: "#3BC4A0"
                }
            },
            grid: {
                "border-radius": "30px",
                border: "1px black solid"
            }
        }
    }

    // Calendar mobile
    const theme_mobile = {
        calendar: {
            width: "80vw",
            shadow: "0px 0px 5px rgba(0, 0, 0, 0.25)",
            colors: {
                background: {
                    highlight: "#3BC4A0"
                }
            }
        }
    }

    export let data
    let openConfirmation = false
    let puestoModal = false
    let successToast = false
    let unSuccessToast = false
    let successChangeToast = false
    let unSuccessChangeToast = false
    let successBackupToast = false
    let unSuccessBackupToast = false
    let unSuccessAvailabilityToast = false
    let successToastPlantilla = false
    let unSuccessToastPlantilla = false
    $: session = $page.data.session
    let plantilla = $page.data.plantilla

    let users = $page.data.users
    let searchTerm = ""
    $: filteredItems = users.filter(person => {
        return (
            person.rango != "general" &&
            person.nombre.toLowerCase().indexOf(searchTerm.toLowerCase()) !== -1
        )
    })

    function change_confirmation_modal() {
        openConfirmation = true
    }

    async function do_backup() {
        // Call a function that only runs in the server side:
        let res_email = session?.user?.email || ""
        if (res_email === "") {
            openConfirmation = false
            return
        }
        const response = await fetch("/api/backupDB", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ email: res_email })
        })

        let result = await response.json()
        result = result["result"]["message"]
        if (result.includes("correctamente")) {
            successBackupToast = true
            setTimeout(() => {
                successBackupToast = false
                location.reload()
            }, 2000)
        } else {
            unSuccessBackupToast = true
        }
    }

    async function eliminar_db() {
        openConfirmation = false

        // Call a function that only runs in the server side:
        let res_email = session?.user?.email || ""
        if (res_email === "") {
            openConfirmation = false
            return
        }
        const response = await fetch("/api/deleteDB", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ email: res_email })
        })

        let result = await response.json()
        result = result["result"]["message"]
        if (result.includes("eliminada")) {
            successToast = true
            setTimeout(() => {
                successToast = false
                location.reload()
            }, 2000)
        } else {
            unSuccessToast = true
        }
    }

    let puestoOsciloscopio
    let stateOsciloscopio
    let nameStateOsciloscopio
    function change_osciloscopio_modal() {
        puestoOsciloscopio = document.getElementById("puesto").value
        stateOsciloscopio = document.getElementById("estado_puesto").value
        if (stateOsciloscopio == 1) {
            nameStateOsciloscopio = "Disponible"
        } else {
            nameStateOsciloscopio = "No Disponible"
        }
        if (puestoOsciloscopio && stateOsciloscopio) {
            puestoModal = true
        }
    }

    async function change_osciloscopio_state() {
        puestoModal = false

        // Call a function that only runs in the server side:
        let res_email = session?.user?.email || ""
        if (res_email === "") {
            puestoModal = false
            return
        }
        const response = await fetch("/api/change_osciloscopio_state", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                email: res_email,
                puesto: puestoOsciloscopio,
                estado: stateOsciloscopio
            })
        })

        let result = await response.json()
        result = result["result"]["message"]
        if (result.includes("cambiado")) {
            successChangeToast = true
            setTimeout(() => {
                successChangeToast = false
                location.reload()
            }, 500)
        } else {
            unSuccessChangeToast = true
        }
    }

    let availabilityModal
    let fechaDisponibilidad
    let horaDisponibilidad
    let estadoDisponibilidad

    function change_availability_modal(dia, hora, estado) {
        fechaDisponibilidad = dia
        horaDisponibilidad = hora
        estadoDisponibilidad = estado
        availabilityModal = true
    }

    async function change_disponibilidad_hora() {
        availabilityModal = false

        // Call a function that only runs in the server side:
        let res_email = session?.user?.email || ""
        if (res_email === "") {
            availabilityModal = false
            return
        }
        const response = await fetch("/api/change_hora_state", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                email: res_email,
                dia: fechaDisponibilidad,
                hora: horaDisponibilidad,
                estado: estadoDisponibilidad
            })
        })

        let result = await response.json()
        result = result["result"]["message"]
        if (result.includes("cambiado")) {
            setTimeout(() => {
                location.reload()
            }, 500)
        } else {
            unSuccessAvailabilityToast = true
            setTimeout(() => {
                unSuccessAvailabilityToast = false
            }, 1000)
        }
    }

    export let form

    async function change_plantilla(dia, hora, estado) {
        let res_email = session?.user?.email || ""
        if (res_email === "") {
            availabilityModal = false
            return
        }
        const response = await fetch("/api/change_plantilla", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ email: res_email, dia: dia, hora: hora, estado: estado })
        })

        let result = await response.json()
        result = result["result"]["message"]
        if (result.includes("correctamente")) {
            successToastPlantilla = true
            setTimeout(() => {
                successToast = false
                location.reload()
            }, 500)
        } else {
            unSuccessToastPlantilla = true
        }
    }

    // Info bools
    let showHelpChangeRole = false
    let showHelpChangeUserRoles = false
    let showHelpDB = false
    let showHelpOsciloscopes = false
    let showHelpShifts = false
    let showHelpActualShifts = false

    function formatDate(date, symbol) {
        const day = date.getDate()
        const month = date.getMonth() + 1 // getMonth() devuelve 0-11
        const year = date.getFullYear()

        return `${day}${symbol}${month}${symbol}${year}`
    }

    function getDay(date) {
        return `${date.getDate()}`
    }
</script>

<Tabs
    defaultClass="flex flex-coll space-x-2 rtl:space-x-reverse overflow-x-auto"
    tabStyle="underline"
    contentClass="p-4"
    class="px-8">
    <TabItem
        open
        title="Cambiar Rol"
        activeClasses="sm:text-base text-xs p-4 text-dele-accent dark:text-dark-accent recompensa:text-recompensa-accent"
        inactiveClasses="text-gray-500 hover:text-dele-color p-4 dark:hover:text-dark-primary recompensa:text-recompensa-primary hover:recompensa:text-white sm:text-base text-xs"
        on:focus={() => {
            form = ""
        }}>
        <!-- Help button -->
        <div class="flex justify-center mb-6">
            <button
                class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-md hover:shadow-lg transition-shadow text-dele-color dark:text-dark-primary recompensa:text-recompensa-primary"
                on:click={() => (showHelpChangeRole = !showHelpChangeRole)}>
                <QuestionCircleSolid class="h-5 w-5" />
                <span>Ayuda</span>
            </button>
        </div>

        <!-- Help tooltip -->
        {#if showHelpChangeRole}
            <div class="relative mb-8">
                <div
                    class="mx-auto max-w-2xl p-4 rounded-lg bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-lg text-black dark:text-white recompensa:text-white">
                    <h3 class="font-bold text-lg mb-2">Cambiar rol</h3>
                    <p>
                        Este tab sirve para cambiar el rol de un usuario que ya se haya registrado
                        en el sistema.
                        <br />
                        <br />
                        Para cambiar el rol de esa persona, simplemente introduce su NIA y selecciona
                        el nuevo rol que debe tener.
                    </p>
                </div>
            </div>
        {/if}

        <form action="?/addUserRol" method="post" use:enhance>
            <div class="grid grid-cols-1 w-auto">
                <div>
                    <Label
                        class="w-4/5 text-xl m-auto text-dele-color recompensa:text-recompensa-primary">
                        NIA
                    </Label>
                    <Input
                        type="text"
                        id="NIA_add"
                        name="NIA_add"
                        placeholder="NIA del usuario..."
                        pattern={"100[0-9]{6}"}
                        required
                        class="w-4/5 m-auto" />
                </div>
            </div>
            <div class="grid grid-cols-1 w-auto mt-4 place-items-center">
                <Label class="text-xl w-auto text-dele-color recompensa:text-recompensa-primary">
                    Selecciona un rol
                </Label>
                <Select
                    class="mt-2 sm:w-1/5 w-2/5"
                    id="rol_add"
                    name="rol_add"
                    items={rols}
                    required
                    placeholder="Rol" />
            </div>
            <Input
                type="hidden"
                id="nia_admin"
                name="nia_admin"
                value={data.session?.user?.email?.split("@")[0]} />

            <Input
                type="hidden"
                id="nombre_admin"
                name="nombre_admin"
                value={data.session?.user?.name} />
            <div class="grid grid-cols-1 w-auto place-items-center">
                <Button
                    type="submit"
                    class="bg-dele-color text-white mt-8 px-8 py-2 text-xl hover:bg-dele-color dark:bg-dark-primary dark:hover:bg-dark-accent recompensa:bg-recompensa-primary hover:recompensa:bg-recompensa-accent">
                    Cambiar rol
                </Button>
                <div></div>
            </div>
        </form>
    </TabItem>
    <TabItem
        title="Roles Usuarios"
        activeClasses="sm:text-base text-xs p-4 text-dele-accent dark:text-dark-accent recompensa:text-recompensa-accent"
        inactiveClasses="text-gray-500 hover:text-dele-color p-4 dark:hover:text-dark-primary recompensa:text-recompensa-primary hover:recompensa:text-white sm:text-base text-xs"
        on:focus={() => {
            form = ""
        }}>
        <!-- Help button -->
        <div class="flex justify-center mb-6">
            <button
                class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-md hover:shadow-lg transition-shadow text-dele-color dark:text-dark-primary recompensa:text-recompensa-primary"
                on:click={() => (showHelpChangeUserRoles = !showHelpChangeUserRoles)}>
                <QuestionCircleSolid class="h-5 w-5" />
                <span>Ayuda</span>
            </button>
        </div>

        <!-- Help tooltip -->
        {#if showHelpChangeUserRoles}
            <div class="relative mb-8">
                <div
                    class="mx-auto max-w-2xl p-4 rounded-lg bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-lg text-black dark:text-white recompensa:text-white">
                    <h3 class="font-bold text-lg mb-2">Ver roles</h3>
                    <p>
                        Esta página muestra a todas las personas que tengan un rol de atención al
                        despacho o de escuela.
                    </p>
                </div>
            </div>
        {/if}

        <TableSearch placeholder="Busca por Nombre" hoverable={true} bind:inputValue={searchTerm}>
            <TableHead>
                <TableHeadCell class="recompensa:bg-recompensa-primary recompensa:text-white">
                    Nombre
                </TableHeadCell>
                <TableHeadCell class="recompensa:bg-recompensa-primary recompensa:text-white">
                    Nia
                </TableHeadCell>
                <TableHeadCell class="recompensa:bg-recompensa-primary recompensa:text-white">
                    Correo
                </TableHeadCell>
                <TableHeadCell class="recompensa:bg-recompensa-primary recompensa:text-white">
                    Rango
                </TableHeadCell>
            </TableHead>
            <TableBody tableBodyClass="divide-y">
                {#if filteredItems != null && filteredItems}
                    {#each filteredItems as item}
                        <TableBodyRow>
                            <TableBodyCell class="recompensa:bg-[#e0e0e0]">
                                {item.nombre}
                            </TableBodyCell>
                            <TableBodyCell class="recompensa:bg-[#e0e0e0]">
                                {item.nia}
                            </TableBodyCell>
                            <TableBodyCell class="recompensa:bg-[#e0e0e0]">
                                {item.correo}
                            </TableBodyCell>
                            <TableBodyCell class="recompensa:bg-[#e0e0e0]">
                                {item.rango.charAt(0).toUpperCase() + item.rango.slice(1)}
                            </TableBodyCell>
                        </TableBodyRow>
                    {/each}
                {/if}
            </TableBody>
        </TableSearch>
    </TabItem>
    <TabItem
        title="Base de Datos"
        activeClasses="sm:text-base text-xs p-4 text-dele-accent dark:text-dark-accent recompensa:text-recompensa-accent"
        inactiveClasses="text-gray-500 hover:text-dele-color p-4 dark:hover:text-dark-primary recompensa:text-recompensa-primary hover:recompensa:text-white sm:text-base text-xs"
        on:focus={() => {
            form = ""
        }}>
        <!-- Help button -->
        <div class="flex justify-center mb-6">
            <button
                class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-md hover:shadow-lg transition-shadow text-dele-color dark:text-dark-primary recompensa:text-recompensa-primary"
                on:click={() => (showHelpDB = !showHelpDB)}>
                <QuestionCircleSolid class="h-5 w-5" />
                <span>Ayuda</span>
            </button>
        </div>

        <!-- Help tooltip -->
        {#if showHelpDB}
            <div class="relative mb-8">
                <div
                    class="mx-auto max-w-2xl p-4 rounded-lg bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-lg text-black dark:text-white recompensa:text-white">
                    <h3 class="font-bold text-lg mb-2">Gestionar Base de Datos</h3>
                    <p>
                        Esta página sirve para hacer copias de seguridad y para eliminar la base de
                        datos.
                        <br />
                        <br />
                        Antes de eliminar la base de datos se realiza una copia de seguridad, pero no
                        la borres a no ser que tengas que hacerlo.
                        <br />
                        <br />
                        Como nota adicional, la eliminación de la base de datos solo borra las reservas
                        de los usuarios (no de las asociaciones) y deja a los usuarios intactos.
                    </p>
                </div>
            </div>
        {/if}

        <section class="grid grid-rows-3 place-items-center mt-8">
            <section>
                <form method="post" use:enhance>
                    <Input
                        type="hidden"
                        required
                        id="email_admin"
                        name="email_admin"
                        value={session?.user?.email} />
                    <Button
                        type="button"
                        class="w-full1 bg-green-500 hover:bg-dele-accent dark:bg-dark-primary dark:hover:bg-dark-accent hover:recompensa:bg-recompensa-accent"
                        on:click={() => {
                            do_backup()
                        }}>
                        Hacer una copia de seguridad
                    </Button>
                </form>
            </section>
            <section>
                <form method="post" use:enhance class="mt-8">
                    <Input
                        type="hidden"
                        required
                        id="email_admin"
                        name="email_admin"
                        value={session?.user?.email} />
                    <Button
                        class="w-full1 bg-red-500 hover:bg-dele-accent dark:bg-red-500 dark:hover:bg-dark-accent hover:recompensa:bg-recompensa-accent"
                        on:click={() => {
                            change_confirmation_modal()
                        }}>
                        Eliminar la base de datos
                    </Button>
                </form>
            </section>

            <section class="hidden">
                <form
                    action="?/RestoreDB2"
                    method="POST"
                    enctype="multipart/form-data"
                    class="mt-8">
                    <Label class="text-xl w-auto text-dele-color">
                        Selecciona el archivo de la base de datos
                    </Label>
                    <Input
                        type="file"
                        id="file"
                        name="file"
                        accept=".db3"
                        required
                        class="w-4/5 m-auto my-4"
                        enctype="multipart/form-data" />

                    <Input
                        type="hidden"
                        id="nia_admin"
                        name="nia_admin"
                        value={data.session?.user?.email} />
                    <Button
                        type="submit"
                        class="w-full1 bg-green-500 hover:bg-dele-accent dark:bg-dark-primary dark:hover:bg-dark-accent">
                        Restaurar la copia de seguridad del archivo subido
                    </Button>
                </form>
            </section>
        </section>
    </TabItem>
    <TabItem
        title="Gestionar Puestos"
        activeClasses="sm:text-base text-xs p-4 text-dele-accent dark:text-dark-accent recompensa:text-recompensa-accent"
        inactiveClasses="text-gray-500 hover:text-dele-color p-4 dark:hover:text-dark-primary recompensa:text-recompensa-primary hover:recompensa:text-white sm:text-base text-xs"
        on:focus={() => {
            form = ""
        }}>
        <!-- Help button -->
        <div class="flex justify-center mb-6">
            <button
                class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-md hover:shadow-lg transition-shadow text-dele-color dark:text-dark-primary recompensa:text-recompensa-primary"
                on:click={() => (showHelpOsciloscopes = !showHelpOsciloscopes)}>
                <QuestionCircleSolid class="h-5 w-5" />
                <span>Ayuda</span>
            </button>
        </div>

        <!-- Help tooltip -->
        {#if showHelpOsciloscopes}
            <div class="relative mb-8">
                <div
                    class="mx-auto max-w-2xl p-4 rounded-lg bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-lg text-black dark:text-white recompensa:text-white">
                    <h3 class="font-bold text-lg mb-2">Gestionar Puestos de Electrónica</h3>
                    <p>
                        Esta página sirve para marcar la disponibilidad de los puestos de
                        electrónica, pudiendo marcarlos como no disponibles.
                        <br />
                        <br />
                        Antes de marcarlo como no disponible ten en cuenta que se mandarán correos a
                        todas las personas afectadas.
                    </p>
                </div>
            </div>
        {/if}

        <section class="grid grid-rows-3 place-items-center mt-8">
            <form method="post" use:enhance>
                <div class="grid grid-cols-1 w-[90vw]">
                    <div class="w-4/5 m-auto">
                        <Label
                            class="w-4/5 text-xl m-auto text-dele-color recompensa:text-recompensa-primary">
                            Puesto de Electrónica
                        </Label>
                        <Select
                            class="mt-2 w-4/5 m-auto"
                            id="puesto"
                            name="puesto"
                            items={puestos}
                            required
                            placeholder="Puesto:" />
                    </div>
                    <div class="w-4/5 m-auto">
                        <Label
                            class="w-4/5 text-xl m-auto text-dele-color recompensa:text-recompensa-primary">
                            Estado
                        </Label>
                        <Select
                            class="mt-2 w-4/5 m-auto"
                            id="estado_puesto"
                            name="estado_puesto"
                            items={estados}
                            required
                            placeholder="Estado:" />
                    </div>
                    <Button
                        type="button"
                        class="w-1/6 m-auto mt-8 text-xl bg-dele-color hover:bg-dele-accent dark:bg-dark-primary dark:hover:bg-dark-accent recompensa:bg-recompensa-primary hover:recompensa:bg-recompensa-accent"
                        on:click={() => {
                            change_osciloscopio_modal()
                        }}>
                        Cambiar estado
                    </Button>
                </div>
            </form>
        </section>
    </TabItem>
    <TabItem
        title="Plantilla de Turnos"
        activeClasses="sm:text-base text-xs p-4 text-dele-accent dark:text-dark-accent recompensa:text-recompensa-accent"
        inactiveClasses="text-gray-500 hover:text-dele-color p-4 dark:hover:text-dark-primary recompensa:text-recompensa-primary hover:recompensa:text-white sm:text-base text-xs"
        on:focus={() => {
            form = ""
        }}>
        <!-- Help button -->
        <div class="flex justify-center mb-6">
            <button
                class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-md hover:shadow-lg transition-shadow text-dele-color dark:text-dark-primary recompensa:text-recompensa-primary"
                on:click={() => (showHelpShifts = !showHelpShifts)}>
                <QuestionCircleSolid class="h-5 w-5" />
                <span>Ayuda</span>
            </button>
        </div>

        <!-- Help tooltip -->
        {#if showHelpShifts}
            <div class="relative mb-8">
                <div
                    class="mx-auto max-w-2xl p-4 rounded-lg bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-lg text-black dark:text-white recompensa:text-white">
                    <h3 class="font-bold text-lg mb-2">Gestionar los turnos semanalmente</h3>
                    <p>
                        Esta página sirve para marcar los turnos que se pueden cubrir semanalmente.
                        <br />
                        <br />
                        Las franjas horarias que no se puedan cubrir aparecerán marcadas en negro, y
                        no podrán ser seleccionadas para ser reservadas en los puestos de electrónica.
                        <br />
                        <br />
                        Es crucial marcar estos horarios al principio de cada cuatrimestre y, si no se
                        puede cubrir turno un día en específico, marcarlo en la pestaña "Turnos de Despacho".
                    </p>
                </div>
            </div>
        {/if}

        <table
            style="border: 2px solid black; border-radius: 13px; border-spacing: 0;"
            class="m-auto mt-12">
            <thead>
                <tr>
                    {#each days as day}
                        <th
                            style="border: 1px solid black; "
                            class="text-center px-3 py-1 border-collapse bg-[#c6c6c6ff]">
                            {day["name"]}
                        </th>
                    {/each}
                </tr>
            </thead>
            <tbody>
                {#if plantilla && plantilla["plantilla"]}
                    {#each franjas as start_hour}
                        <tr>
                            {#each days as day}
                                {#if plantilla["plantilla"][day["value"] + "-" + start_hour] == 0}
                                    <td
                                        style="border: 1px solid black;"
                                        class="bg-black text-white text-center p-3 cursor-pointer"
                                        on:click={() => {
                                            change_plantilla(day["value"], start_hour, 1)
                                        }}>
                                        {start_hour}:00 - {start_hour + 2}:00
                                    </td>
                                {:else}
                                    <td
                                        style="border: 1px solid black;"
                                        class="bg-green-500 text-black text-center p-3 cursor-pointer"
                                        on:click={() => {
                                            change_plantilla(day["value"], start_hour, 0)
                                        }}>
                                        {start_hour}:00 - {start_hour + 2}:00
                                    </td>
                                {/if}
                            {/each}
                        </tr>
                    {/each}
                {/if}
            </tbody>
        </table>
    </TabItem>
    <TabItem
        title="Turnos de Despacho"
        activeClasses="sm:text-base text-xs p-4 text-dele-accent dark:text-dark-accent recompensa:text-recompensa-accent"
        inactiveClasses="text-gray-500 hover:text-dele-color p-4 dark:hover:text-dark-primary recompensa:text-recompensa-primary hover:recompensa:text-white sm:text-base text-xs"
        on:focus={() => {
            form = ""
        }}>
        <!-- Help button -->
        <div class="flex justify-center mb-6">
            <button
                class="flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-md hover:shadow-lg transition-shadow text-dele-color dark:text-dark-primary recompensa:text-recompensa-primary"
                on:click={() => (showHelpActualShifts = !showHelpActualShifts)}>
                <QuestionCircleSolid class="h-5 w-5" />
                <span>Ayuda</span>
            </button>
        </div>

        <!-- Help tooltip -->
        {#if showHelpActualShifts}
            <div class="relative mb-8">
                <div
                    class="mx-auto max-w-2xl p-4 rounded-lg bg-white dark:bg-dark-secondary recompensa:bg-recompensa-secondary shadow-lg text-black dark:text-white recompensa:text-white">
                    <h3 class="font-bold text-lg mb-2">Gestionar los turnos día a día</h3>
                    <p>
                        Esta página sirve para marcar los turnos que no se puedan cubrir en días
                        específicos, haz click siempre en buscar tras seleccionar el día.
                        <br />
                        <br />
                        Las franjas horarias que no se puedan cubrir aparecerán marcadas en negro, y
                        no podrán ser seleccionadas para ser reservadas en los puestos de electrónica.
                        Además, una franja horaria no se podrá marcar como libre si en la plantilla se
                        indica lo contrario.
                        <br />
                        <br />
                        Si esa franja horaria estaba ocupada, se enviará un correo de cancelación de
                        la reserva del osciloscopio a todos los estudiantes afectados.
                    </p>
                </div>
            </div>
        {/if}

        <div class="grid grid-cols-1 place-items-center mt-12">
            <DateInput
                bind:value={date}
                on:select={() => {
                    form = null
                }} />
        </div>

        <form action="?/ReservasDia" method="post" use:enhance>
            <div class="grid grid-cols-1 place-items-center mt-6">
                <Input
                    type="hidden"
                    required
                    id="dia_r"
                    name="dia_r"
                    value={formatDate(date, "-")} />
                <Button
                    class="bg-dele-color text-white mt-8 px-8 py-2 text-xl hover:bg-dele-color dark:bg-dark-primary dark:hover:bg-dark-accent recompensa:bg-recompensa-primary hover:recompensa:bg-recompensa-accent"
                    type="submit">
                    Buscar
                </Button>
            </div>
        </form>

        {#if form != null && form && form.reservas}
            <div class="grid grid-cols-1 place-self-center mt-6">
                <div class="w-auto m-auto dark:text-white grid sm:grid-cols-4 grid-cols-2">
                    <span class="flex items-center recompensa:text-white">
                        <Indicator size="lg" color="green" class="me-1.5" />Libre
                    </span>
                    <span class="flex items-center recompensa:text-white">
                        <Indicator size="lg" color="red" class="me-1.5" />Ocupada
                    </span>
                    <span class="flex items-center recompensa:text-white">
                        <Indicator size="lg" color="dark" class="me-1.5" />No Disponible
                    </span>
                    <span class="flex items-center recompensa:text-white">
                        <Indicator size="lg" color="dark" class="me-1.5" />(P) No Disponible en
                        Plantilla
                    </span>
                </div>
            </div>
            <table
                style="border: 2px solid black; border-radius: 13px; border-spacing: 0; "
                class="m-auto mt-6">
                <tbody>
                    <tr>
                        {#if plantilla && plantilla["plantilla"]}
                            {#each franjas as start_hour}
                                {#if plantilla["plantilla"][getDay(date) + "-" + start_hour] != 0}
                                    {#if form.reservas[formatDate(date, "/") + "-" + start_hour]}
                                        {#if form.reservas[formatDate(date, "/") + "-" + start_hour] == "no_disponible"}
                                            <td
                                                style="border: 1px solid black;"
                                                class="bg-black text-white text-center p-3 cursor-pointer"
                                                on:click={() => {
                                                    change_availability_modal(
                                                        formatDate(date, "/"),
                                                        start_hour,
                                                        "disponible"
                                                    )
                                                }}>
                                                {start_hour}:00 - {start_hour + 2}:00
                                            </td>
                                        {:else}
                                            <td
                                                style="border: 1px solid black;"
                                                class="bg-red-500 text-center p-3 cursor-pointer"
                                                on:click={() => {
                                                    change_availability_modal(
                                                        formatDate(date, "/"),
                                                        start_hour,
                                                        "no_disponible"
                                                    )
                                                }}>
                                                {start_hour}:00 - {start_hour + 2}:00
                                            </td>
                                        {/if}
                                    {:else}
                                        <td
                                            style="border: 1px solid black;"
                                            class="bg-green-500 text-center p-3 cursor-pointer"
                                            on:click={() => {
                                                change_availability_modal(
                                                    formatDate(date, "/"),
                                                    start_hour,
                                                    "no_disponible"
                                                )
                                            }}>
                                            {start_hour}:00 - {start_hour + 2}:00
                                        </td>
                                    {/if}
                                {:else}
                                    <td
                                        style="border: 1px solid black;"
                                        class="bg-black text-white text-center p-3 cursor-pointer">
                                        {start_hour}:00 - {start_hour + 2}:00 (P)
                                    </td>
                                {/if}
                            {/each}
                        {/if}
                    </tr>
                </tbody>
            </table>
        {/if}
    </TabItem>
</Tabs>

<Modal
    bind:open={openConfirmation}
    size="xs"
    autoclose={false}
    class="w-full recompensa:bg-recompensa-secondary">
    <h3
        class="mb-2 text-xl font-medium text-gray-900 dark:text-white recompensa:text-recompensa-primary">
        Eliminar la base de datos
    </h3>
    <p class="text-black dark:text-white recompensa:text-white">
        Antes de eliminar la base de datos, se te mandará un correo con una copia de seguridad. Ten
        en cuenta que este borrado <b>sólo</b>
        afecta a las reservas, no a los usuarios.
        <br />
        <br />
        Haz click en el siguiente botón para confirmar el borrado.
    </p>
    <div class="grid grid-cols-1 place-items-center">
        <Button
            type="button"
            class="w-full bg-green-500 hover:bg-dele-accent dark:bg-dark-primary dark:hover:bg-dark-accent recompensa:bg-recompensa-primary hover:recompensa:bg-recompensa-accent"
            on:click={() => {
                eliminar_db()
            }}>
            Borrar la Base de Datos
        </Button>
    </div>
</Modal>

<Modal
    bind:open={puestoModal}
    size="xs"
    autoclose={false}
    class="w-full recompensa:bg-recompensa-secondary">
    <h3
        class="mb-2 text-xl font-medium text-gray-900 dark:text-white recompensa:text-recompensa-primary">
        Cambiar el estado de un puesto
    </h3>
    <p class="text-black dark:text-white recompensa:text-white">
        Antes de cambiar el estado del puesto, ten en cuenta que si lo marcas como no disponible se
        eliminarán las reservas.
    </p>

    <form class="flex flex-col space-y-6">
        <Label class="space-y-2">
            <span class="recompensa:text-recompensa-primary">Puesto</span>
            <Input
                type="text"
                id="puesto_modal"
                name="puesto_modal"
                value={puestoOsciloscopio}
                readonly
                required />
        </Label>
        <Label class="space-y-2">
            <span class="recompensa:text-recompensa-primary">Estado</span>
            <Input
                type="text"
                id="estado_modal"
                name="estado_modal"
                value={nameStateOsciloscopio}
                readonly
                required />
        </Label>
        <p class="font-bold text-xl text-center recompensa:text-recompensa-primary">
            Haz click en el siguiente botón para confirmar el cambio
        </p>
        <Button
            type="button"
            class="w-full bg-green-500 hover:bg-dele-accent dark:bg-dark-primary dark:hover:bg-dark-accent recompensa:bg-recompensa-primary hover:recompensa:bg-recompensa-accent"
            on:click={() => {
                change_osciloscopio_state()
            }}>
            Cambiar el Estado del Puesto
        </Button>
    </form>
</Modal>

<Modal
    bind:open={availabilityModal}
    size="xs"
    autoclose={false}
    class="w-full recompensa:bg-recompensa-secondary">
    <h3
        class="mb-2 text-xl font-medium text-gray-900 dark:text-white recompensa:text-recompensa-primary">
        Cambiar la disponibilidad
    </h3>
    <p class="text-black dark:text-white recompensa:text-white">
        Vas a cambiar la disponibilidad de todos los puestos a la siguiente hora y fecha:
    </p>
    <form class="flex flex-col space-y-6">
        <Input
            type="text"
            id="fecha_disponibilidad"
            name="fecha_disponibilidad"
            value={fechaDisponibilidad}
            readonly
            required />
        <Input
            type="text"
            id="hora_disponibilidad"
            name="hora_disponibilidad"
            value={horaDisponibilidad + ":00 - " + (horaDisponibilidad + 2) + ":00"}
            readonly
            required />
        <p class="font-bold text-xl text-center recompensa:text-recompensa-primary">
            Vas a cambiarlo al siguiente estado:
        </p>
        <Input
            type="text"
            id="estado_disponibilidad"
            name="estado_disponibilidad"
            value={estadoDisponibilidad}
            readonly
            required />
        <p class="font-bold text-xl text-center recompensa:text-recompensa-primary">
            ¿Quieres cambiarlo?
        </p>
        <Button
            type="button"
            class="w-full bg-green-500 hover:bg-dele-accent dark:bg-dark-primary dark:hover:bg-dark-accent recompensa:bg-recompensa-primary hover:recompensa:bg-recompensa-accent"
            on:click={() => {
                change_disponibilidad_hora()
            }}>
            Cambiar el Estado
        </Button>
    </form>
</Modal>

{#if successBackupToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card
            class="bg-green-500 dark:text-white text-white dark:bg-green-500 recompensa:bg-green-500">
            <p class="p-2">Se ha realizado con éxito el Backup.</p>
        </Card>
    </div>
{:else if unSuccessBackupToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card class="bg-red-500 dark:text-white text-white dark:bg-red-500 recompensa:bg-red-500">
            <p class="p-2">No se ha podido realizar el Backup.</p>
        </Card>
    </div>
{/if}

{#if successToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card
            class="bg-green-500 dark:text-white text-white dark:bg-green-500 recompensa:bg-green-500">
            <p class="p-2">Base de datos borrada con éxito.</p>
        </Card>
    </div>
{:else if unSuccessToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card class="bg-red-500 dark:text-white text-white dark:bg-red-500 recompensa:bg-red-500">
            <p class="p-2">No se ha podido borrar la base de datos.</p>
        </Card>
    </div>
{/if}

{#if successChangeToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card
            class="bg-green-500 dark:text-white text-white dark:bg-green-500 recompensa:bg-green-500">
            <p class="p-2">Estado del puesto cambiado.</p>
        </Card>
    </div>
{:else if unSuccessChangeToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card class="bg-red-500 dark:text-white text-white dark:bg-red-500 recompensa:bg-red-500">
            <p class="p-2">No se ha podido cambiar el estado del puesto.</p>
        </Card>
    </div>
{/if}

{#if unSuccessAvailabilityToast}
    <div class="fixed bottom-0 right-0 m-5">
        <Card class="bg-red-500 dark:text-white text-white dark:bg-red-500 recompensa:bg-red-500">
            <p class="p-2">No se ha podido cambiar el estado de la hora</p>
        </Card>
    </div>
{/if}

{#if successToastPlantilla}
    <div class="fixed bottom-0 right-0 m-5">
        <Card
            class="bg-green-500 dark:text-white text-white dark:bg-green-500 recompensa:bg-green-500">
            <p class="p-2">Estado de la plantilla cambiado</p>
        </Card>
    </div>
{:else if unSuccessToastPlantilla}
    <div class="fixed bottom-0 right-0 m-5">
        <Card class="bg-red-500 dark:text-white text-white dark:bg-red-500 recompensa:bg-red-500">
            <p class="p-2">No se ha podido cambiar el estado de la plantilla</p>
        </Card>
    </div>
{/if}
